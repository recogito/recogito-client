---
import { getMyProfile } from '@backend/crud';
import { createSupabaseServerClient } from '@backend/supabaseServerClient';
import { defaultLang, languages } from '@i18n';
import parser from 'accept-language-parser';

const accepts = Astro.request.headers.get('accept-language');

const lang = accepts ? parser.pick(Object.keys(languages), accepts) : defaultLang;

console.log('[index] creating the server client');
const supabase = await createSupabaseServerClient(Astro.cookies);
console.log('[index] success. retrieving my profile.');

const me = await getMyProfile(supabase);
console.log('[index] got my profile:')
console.log(me);
if (me.error || !me.data) {
  console.log('[index] User not logged in - redirecting to sign-in')
  return Astro.redirect(`/${lang}/sign-in?redirect-to=${Astro.url.pathname}`);
} else {
  console.log('[index] user logged in redirecting to:' + `/${lang}/projects`);
  return Astro.redirect(`/${lang}/projects`);
}
---

