---
import ProjectLayout from '@layouts/project/ProjectLayout.astro';
import { createSupabaseServerClient } from '@backend/supabaseServerClient';
import { getMyProfile } from '@backend/crud';
import { getLangFromUrl } from '@i18n';
import { getInstalledPlugins, getProjectExtended } from '@backend/helpers';
import { ProjectPlugins } from '@apps/project-plugins';
import PluginRegistry from '@components/Plugins/PluginRegistry';

const lang = getLangFromUrl(Astro.url);

const supabase = await createSupabaseServerClient(Astro.request, Astro.cookies);
if (!supabase)
  return Astro.redirect(`/${lang}/sign-in`);

const projectId = Astro.params.project;

const profile = await getMyProfile(supabase);
if (profile.error || !profile.data) { 
  const error = await fetch(`${Astro.url}/500`);
  return new Response(error.body, { headers: error.headers, status: 500 }); 
}

const project = await getProjectExtended(supabase, projectId as string);
if (project.error || !project.data) { 
  const error = await fetch(`${Astro.url}/404`);
  return new Response(error.body, { 
    headers: { 'Content-Type': 'text/html;charset=utf-8' },
    status: 404, 
    statusText: 'Not Found' 
  }); 
}

const installedPlugins = await getInstalledPlugins(supabase, projectId as string);
if (installedPlugins.error || !installedPlugins.data) {
  const error = await fetch(`${Astro.url}/500`);
  return new Response(error.body, { headers: error.headers, status: 500 }); 
}
---
<ProjectLayout active="Add Ons" user={profile.data} project={project.data}>
  <ProjectPlugins 
    client:load
    project={project.data}
    availablePlugins={PluginRegistry.listAvailablePlugins()} 
    installedPlugins={PluginRegistry.resolvePlugins(installedPlugins.data)} />
</ProjectLayout>